# Vector configuration for log shipping

# Data directory for Vector's state
data_dir: "/var/lib/vector"

# Get demo logs as an example
sources:
  demo_source:
    type: demo_logs
    format: apache_common
    lines:
      - line1

# Transform: Parse JSON logs and format for Locog API
transforms:
  parse_and_enrich:
    type: "remap"
    inputs: 
      - demo_source
    source: |
      # Parse JSON from log message
      parsed = {}
      if is_string(.message) {
        parsed, err = parse_json(.message)
        if err != null {
          # If not JSON, treat the whole message as a plain log
          parsed = {
            "message": .message,
            "level": "INFO"
          }
        }
      }

      # Build field values with fallbacks (using conditionals instead of ?? for null handling)
      ts = if !is_nullish(parsed.timestamp) {
        parsed.timestamp
      } else if !is_nullish(.timestamp) {
        .timestamp
      } else {
        now()
      }

      svc = if !is_nullish(parsed.service) {
        parsed.service
      } else if !is_nullish(.container_name) {
        .container_name
      } else {
        "unknown"
      }

      log_level = if !is_nullish(parsed.level) {
        parsed.level
      } else {
        "INFO"
      }

      msg = if !is_nullish(parsed.message) {
        parsed.message
      } else if !is_nullish(parsed.msg) {
        parsed.msg
      } else {
        "no message"
      }

      hostname = if !is_nullish(parsed.host) {
        parsed.host
      } else {
        get_hostname!()
      }

      # Construct output with only Locog API fields
      . = {
        "timestamp": ts,
        "service": svc,
        "level": log_level,
        "message": msg,
        "host": hostname,
      }

      # Add metadata if present (optional field)
      if exists(parsed.metadata) {
        .metadata = parsed.metadata
      }


sinks:
  locog:
    type: "http"
    inputs: ["parse_and_enrich"]
    uri: "http://locog:5081/api/ingest"
    encoding:
      codec: "json"

    # Batch settings for better performance
    batch:
      max_bytes: 1048576  # 1MB
      max_events: 100
      timeout_secs: 5

    # Retry settings
    buffer: 
      type: "disk"
      max_size: 268435488  # 256MB buffer
      when_full: "drop_newest"

    # Health check configuration
    healthcheck:
      enabled: true